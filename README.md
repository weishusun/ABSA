# ABSA èˆ†æƒ…åˆ†æç³»ç»Ÿ

ä¸€ä¸ªé¢å‘å¤šé¢†åŸŸï¼ˆæ‰‹æœºã€æ±½è½¦ã€ç¬”è®°æœ¬ã€ç¾å¦†ç­‰ï¼‰çš„è¯„è®ºæ•°æ®æƒ…æ„Ÿåˆ†æç³»ç»Ÿï¼Œæ”¯æŒä»åŸå§‹ JSON/JSONL æ•°æ®åˆ°æœ€ç»ˆæƒ…æ„Ÿåˆ†ææŠ¥è¡¨çš„å®Œæ•´æµç¨‹ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [ç¯å¢ƒå®‰è£…](#ç¯å¢ƒå®‰è£…)
- [ç›®å½•ç»“æ„è¯´æ˜](#ç›®å½•ç»“æ„è¯´æ˜)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
  - [å¯åŠ¨ Web UI (app.py)](#å¯åŠ¨-web-ui-apppy)
  - [ä¾§è¾¹æ åŠŸèƒ½è¯´æ˜](#ä¾§è¾¹æ åŠŸèƒ½è¯´æ˜)
- [åˆ†æ­¥ä½¿ç”¨è¯´æ˜](#åˆ†æ­¥ä½¿ç”¨è¯´æ˜)
  - [Step 00: æ•°æ®å‡†å¤‡](#step-00-æ•°æ®å‡†å¤‡)
  - [Step 01: è¦†ç›–ç‡å®éªŒå®¤](#step-01-è¦†ç›–ç‡å®éªŒå®¤)
  - [Step 02: ç”Ÿæˆä¼ªæ ‡ç­¾](#step-02-ç”Ÿæˆä¼ªæ ‡ç­¾)
  - [Step 03: æ¨¡å‹è®­ç»ƒ](#step-03-æ¨¡å‹è®­ç»ƒ)
  - [Step 04: æ¨ç†ä¸éªŒè¯](#step-04-æ¨ç†ä¸éªŒè¯)
  - [Step 05: èšåˆä¸æŠ¥è¡¨](#step-05-èšåˆä¸æŠ¥è¡¨)
- [å‘½ä»¤è¡Œä½¿ç”¨](#å‘½ä»¤è¡Œä½¿ç”¨)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é¡¹ç›®ç®€ä»‹

ABSA (Aspect-Based Sentiment Analysis) èˆ†æƒ…åˆ†æç³»ç»Ÿæ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„è¯„è®ºæƒ…æ„Ÿåˆ†æè§£å†³æ–¹æ¡ˆï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

- **å¤šé¢†åŸŸæ”¯æŒ**ï¼šæ”¯æŒæ‰‹æœº (phone)ã€æ±½è½¦ (car)ã€ç¬”è®°æœ¬ (laptop)ã€ç¾å¦† (beauty) ç­‰å¤šä¸ªé¢†åŸŸ
- **æ•°æ®æ¸…æ´—ä¸æ ‡å‡†åŒ–**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ¸…æ´—åŸå§‹ JSON/JSONL æ•°æ®ï¼Œæ”¯æŒå¤šå“ç‰Œã€å¤šå‹å·çš„æ•°æ®ç»„ç»‡
- **æ–¹é¢æ ‡æ³¨**ï¼šåŸºäºè§„åˆ™è¯å…¸çš„æ–¹é¢è¯åŒ¹é…ï¼Œæ”¯æŒ L1/L2 å±‚çº§åˆ†ç±»
- **æƒ…æ„Ÿåˆ†æ**ï¼šé‡‡ç”¨ Teacher-Student æ¶æ„ï¼Œä½¿ç”¨ LLM ç”Ÿæˆä¼ªæ ‡ç­¾ï¼Œè®­ç»ƒè½»é‡çº§ LoRA æ¨¡å‹è¿›è¡Œå…¨é‡æ¨ç†
- **å¯è§†åŒ–æŠ¥è¡¨**ï¼šç”Ÿæˆ Excel æŠ¥è¡¨å’Œ Web å‹å¥½çš„æ•°æ®å¯¼å‡º

### æ ¸å¿ƒæµç¨‹

```
åŸå§‹æ•°æ® (JSON/JSONL)
    â†“
Step 00: æ•°æ®æ¸…æ´—ä¸åˆ‡å¥ â†’ clean_sentences.parquet
    â†“
æ–¹é¢æ ‡æ³¨ (Tagging) â†’ aspect_sentences.parquet
    â†“
Step 01: æ„å»ºè®­ç»ƒå€™é€‰å¯¹ â†’ train_candidates.parquet
    â†“
Step 02: LLM ä¼ªæ ‡ç­¾ç”Ÿæˆ â†’ train_pseudolabel.parquet
    â†“
Step 03: LoRA æ¨¡å‹è®­ç»ƒ â†’ step03_model/
    â†“
Step 04: å…¨é‡æ¨ç† â†’ asc_pred_ds/
    â†“
Step 05: èšåˆä¸æŠ¥è¡¨ â†’ Excel + web_exports/
```

---

## ç¯å¢ƒå®‰è£…

### å‰ç½®è¦æ±‚

- Python 3.8+
- Windows / Linux / macOS
- (å¯é€‰) NVIDIA GPU + CUDA (ç”¨äºæ¨¡å‹è®­ç»ƒå’Œæ¨ç†åŠ é€Ÿ)

### å®‰è£…æ­¥éª¤

1. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**ï¼ˆæ¨èï¼‰

```bash
# Windows
python -m venv .venv
.\.venv\Scripts\activate

# Linux/macOS
python -m venv .venv
source .venv/bin/activate
```

2. **å®‰è£…ä¾èµ–**

```bash
pip install -r requirements.txt
```

3. **å®‰è£… PyTorch**ï¼ˆå¦‚éœ€ GPU æ”¯æŒï¼‰

```bash
# è®¿é—® https://pytorch.org/ è·å–é€‚åˆæ‚¨ç³»ç»Ÿçš„å®‰è£…å‘½ä»¤
# ä¾‹å¦‚ Windows + CUDA 11.8:
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### ä¸»è¦ä¾èµ–è¯´æ˜

- **æ•°æ®å¤„ç†**ï¼špandas, pyarrow, orjson
- **NLP æ¨¡å‹**ï¼štransformers, accelerate, sentence-transformers, setfit
- **Web UI**ï¼šstreamlit (ç”¨äº app.py)
- **ä¸­æ–‡å¤„ç†**ï¼šjieba
- **å…¶ä»–**ï¼štyper, loguru, tqdm, PyYAML

---

## ç›®å½•ç»“æ„è¯´æ˜

```
ABSA/
â”œâ”€â”€ app.py                          # Streamlit Web UI ä¸»å…¥å£
â”œâ”€â”€ requirements.txt                 # Python ä¾èµ–åˆ—è¡¨
â”‚
â”œâ”€â”€ scripts/                         # æ ¸å¿ƒè„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ step00_ingest_json_to_clean_sentences.py  # Step 00: æ•°æ®æ¸…æ´—
â”‚   â”œâ”€â”€ tag_aspects.py              # æ–¹é¢æ ‡æ³¨è„šæœ¬
â”‚   â”œâ”€â”€ pipeline_e2e.py             # ç«¯åˆ°ç«¯æµæ°´çº¿
â”‚   â”œâ”€â”€ route_b_sentiment/          # Route B æƒ…æ„Ÿåˆ†æé“¾è·¯
â”‚   â”‚   â”œâ”€â”€ pipeline.py             # ä¸»æµæ°´çº¿å…¥å£
â”‚   â”‚   â”œâ”€â”€ sentiment_01_build_aspect_pairs_and_train_candidates.py
â”‚   â”‚   â”œâ”€â”€ sentiment_02_pseudolabel_openai.py
â”‚   â”‚   â”œâ”€â”€ sentiment_03_train_asc_lora.py
â”‚   â”‚   â”œâ”€â”€ sentiment_04_infer_asc.py
â”‚   â”‚   â”œâ”€â”€ sentiment_05_aggregate_and_build_excels.py
â”‚   â”‚   â””â”€â”€ export_web_tables_l1_11.py
â”‚   â”œâ”€â”€ domains/                    # åŸŸçº§å¿«æ·è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ phone/run_full.ps1
â”‚   â”‚   â”œâ”€â”€ phone/run_smoke.ps1
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ tools/                      # å·¥å…·è„šæœ¬
â”‚
â”œâ”€â”€ configs/                        # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ domains/                    # æ–°ç»“æ„ï¼ˆæ¨èï¼‰
â”‚   â”‚   â”œâ”€â”€ phone/
â”‚   â”‚   â”‚   â”œâ”€â”€ aspects.yaml        # æ–¹é¢è¯è¡¨é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ domain.yaml         # é¢†åŸŸæ¸…æ´—é…ç½®
â”‚   â”‚   â”œâ”€â”€ car/
â”‚   â”‚   â”œâ”€â”€ laptop/
â”‚   â”‚   â””â”€â”€ beauty/
â”‚   â””â”€â”€ aspects_*.yaml              # æ—§ç»“æ„ï¼ˆå…¼å®¹ï¼‰
â”‚
â”œâ”€â”€ data/                           # åŸå§‹æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ phone/
â”‚   â”‚   â”œâ”€â”€ iPhone/
â”‚   â”‚   â”œâ”€â”€ galaxy/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ car/
â”‚   â”œâ”€â”€ laptop/
â”‚   â””â”€â”€ beauty/
â”‚
â”œâ”€â”€ outputs/                        # è¾“å‡ºç›®å½•ï¼ˆgitignoreï¼‰
â”‚   â”œâ”€â”€ <domain>/
â”‚   â”‚   â”œâ”€â”€ clean_sentences.parquet
â”‚   â”‚   â”œâ”€â”€ aspect_sentences.parquet
â”‚   â”‚   â”œâ”€â”€ runs/                   # è¿è¡Œç»“æœ
â”‚   â”‚   â”‚   â””â”€â”€ <run_id>/
â”‚   â”‚   â”‚       â”œâ”€â”€ step01_pairs/
â”‚   â”‚   â”‚       â”œâ”€â”€ step02_pseudo/
â”‚   â”‚   â”‚       â”œâ”€â”€ step03_model/
â”‚   â”‚   â”‚       â”œâ”€â”€ step04_pred/
â”‚   â”‚   â”‚       â”œâ”€â”€ step05_agg/
â”‚   â”‚   â”‚       â”œâ”€â”€ web_exports/
â”‚   â”‚   â”‚       â””â”€â”€ meta/
â”‚   â”‚   â”œâ”€â”€ logs/
â”‚   â”‚   â””â”€â”€ meta/
â”‚
â”œâ”€â”€ aspects/                        # é¢†åŸŸè¯è¡¨èµ„äº§ï¼ˆéƒ¨åˆ†é¢†åŸŸï¼‰
â”‚   â””â”€â”€ phone/
â”‚       â”œâ”€â”€ lexicons/               # ç»†ç²’åº¦è¯è¡¨
â”‚       â””â”€â”€ stoplist.txt           # åœç”¨è¯
â”‚
â””â”€â”€ docs/                           # æ–‡æ¡£ç›®å½•
    â”œâ”€â”€ PROJECT_OVERVIEW.md
    â”œâ”€â”€ PIPELINE_RUNBOOK.md
    â”œâ”€â”€ IO_CONTRACTS.md
    â””â”€â”€ ...
```

---

## ä½¿ç”¨æŒ‡å—

### å¯åŠ¨ Web UI (app.py)

Web UI æä¾›äº†å¯è§†åŒ–çš„æ“ä½œç•Œé¢ï¼Œé€‚åˆäº¤äº’å¼ä½¿ç”¨ã€‚

#### å¯åŠ¨å‘½ä»¤

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå
streamlit run app.py
```

å¯åŠ¨åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ `http://localhost:8501`ã€‚

#### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¯é€‰ï¼‰

```bash
# Windows PowerShell
$env:ABSA_WORKSPACE="C:\path\to\workspace"
$env:OPENAI_API_KEY="sk-..."
$env:OPENAI_BASE_URL="https://api.deepseek.com"

# Linux/macOS
export ABSA_WORKSPACE="/path/to/workspace"
export OPENAI_API_KEY="sk-..."
export OPENAI_BASE_URL="https://api.deepseek.com"
```

### ä¾§è¾¹æ åŠŸèƒ½è¯´æ˜

Web UI çš„ä¾§è¾¹æ åŒ…å«ä»¥ä¸‹æ ¸å¿ƒé…ç½®ï¼š

#### 1. å·¥ä½œåŒºè®¾ç½®

- **æ•°æ®å­˜æ”¾ç›®å½• (Workspace)**ï¼šè®¾ç½®è¾“å…¥/è¾“å‡ºæ•°æ®çš„æ ¹ç›®å½•
  - é»˜è®¤ï¼šä»£ç ç›®å½•ä¸‹çš„ `workspace_data`
  - å¯é€šè¿‡ç¯å¢ƒå˜é‡ `ABSA_WORKSPACE` è®¾ç½®
  - ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»º `inputs/` å’Œ `outputs/` å­ç›®å½•

#### 2. ä»»åŠ¡å‚æ•°

- **é¢†åŸŸ (Domain)**ï¼šé€‰æ‹©åˆ†æé¢†åŸŸï¼ˆcar / phone / laptop / beautyï¼‰
- **ä»»åŠ¡æ ‡è¯† (Run ID)**ï¼šæœ¬æ¬¡è¿è¡Œçš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºç»„ç»‡è¾“å‡ºæ–‡ä»¶
  - å»ºè®®æ ¼å¼ï¼š`YYYYMMDD_<domain>_v0`ï¼Œä¾‹å¦‚ `20260105_phone_v0`

#### 3. LLM æ¨¡å‹é…ç½®

é…ç½®ç”¨äº Step 02 ä¼ªæ ‡ç­¾ç”Ÿæˆçš„ LLM APIï¼š

- **API æœåŠ¡å•†**ï¼šæ”¯æŒ OpenAIã€DeepSeekã€Moonshot (Kimi)ã€é˜¿é‡Œäº‘é€šä¹‰åƒé—®ã€è‡ªå®šä¹‰
- **API Key**ï¼šå¡«å…¥å¯¹åº”æœåŠ¡å•†çš„ API Key
- **Base URL**ï¼šAPI è¯·æ±‚åœ°å€ï¼ˆé€‰æ‹©æœåŠ¡å•†åè‡ªåŠ¨å¡«å……ï¼‰
- **æ¨¡å‹åç§°**ï¼šé€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°
- **æµ‹è¯•è¿æ¥**ï¼šéªŒè¯ API é…ç½®æ˜¯å¦æ­£ç¡®

#### 4. æµç¨‹å¯¼èˆª

- **0ï¸âƒ£ æ•°æ®å‡†å¤‡**ï¼šStep 00 æ•°æ®æ¸…æ´—ç•Œé¢
- **1ï¸âƒ£ è¦†ç›–ç‡å®éªŒå®¤**ï¼šStep 01 æ–¹é¢æ ‡æ³¨ä¸è¦†ç›–ç‡åˆ†æ
- **2ï¸âƒ£ è®­ç»ƒä¸æ¨ç†**ï¼šStep 02-05 çš„æµæ°´çº¿æ“ä½œ
- **3ï¸âƒ£ æ•°æ®çœ‹æ¿**ï¼šç»“æœå¯è§†åŒ–ä¸æŠ¥è¡¨æŸ¥çœ‹

---

## åˆ†æ­¥ä½¿ç”¨è¯´æ˜

### Step 00: æ•°æ®å‡†å¤‡

**ç›®æ ‡**ï¼šå°†åŸå§‹ JSON/JSONL æ•°æ®æ¸…æ´—å¹¶åˆ‡å¥ï¼Œç”Ÿæˆæ ‡å‡†åŒ–çš„å¥å­çº§æ•°æ®ã€‚

#### æ•°æ®æ ¼å¼è¦æ±‚

- **è¾“å…¥è·¯å¾„**ï¼š`data/<domain>/<brand>/<model>/*.json` æˆ– `*.jsonl`
- **å¿…éœ€å­—æ®µ**ï¼šå†…å®¹å­—æ®µï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼š`content` / `text` / `comment` / `review` / `body` / `è¯„ä»·å†…å®¹`ï¼‰
- **å¯é€‰å­—æ®µ**ï¼šæ—¶é—´å­—æ®µï¼ˆ`ctime` / `create_time` / `comment_time` ç­‰ï¼‰ã€ID å­—æ®µã€å¹³å°ä¿¡æ¯ç­‰

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼ 1ï¼šWeb UI**

1. åœ¨ä¾§è¾¹æ é€‰æ‹©é¢†åŸŸå’Œ Run ID
2. è¿›å…¥ "0ï¸âƒ£ æ•°æ®å‡†å¤‡" é¡µé¢
3. ç¡®è®¤æ‰«æç›®å½•ï¼ˆé»˜è®¤ï¼š`workspace/inputs/<domain>`ï¼‰
4. ç‚¹å‡» "â–¶ï¸ å¼€å§‹æ¸…æ´— (Run Step 00)"
5. æŸ¥çœ‹ç»“æœé¢„è§ˆ

**æ–¹å¼ 2ï¼šå‘½ä»¤è¡Œ**

```bash
python -u scripts/step00_ingest_json_to_clean_sentences.py \
  --domain phone \
  --data-root data/phone \
  --output outputs/phone/clean_sentences.parquet
```

#### è¾“å‡ºè¯´æ˜

- **clean_sentences.parquet**ï¼šå¥å­çº§æ•°æ®ï¼ŒåŒ…å«å­—æ®µï¼š
  - `domain`, `brand`, `model`, `doc_id`, `sentence_idx`
  - `sentence`ï¼ˆæ¸…æ´—åçš„å¥å­ï¼‰
  - `ctime`ï¼ˆæ—¶é—´æˆ³ï¼‰
  - `source_path`ï¼ˆæºæ–‡ä»¶è·¯å¾„ï¼‰

---

### Step 01: è¦†ç›–ç‡å®éªŒå®¤

**ç›®æ ‡**ï¼šä½¿ç”¨è§„åˆ™è¯å…¸åŒ¹é…æ–¹é¢è¯ï¼Œè®¡ç®—è¦†ç›–ç‡ï¼Œå¹¶ä¼˜åŒ–è¯è¡¨ã€‚

#### é…ç½®æ–‡ä»¶

- **è·¯å¾„**ï¼š`configs/domains/<domain>/aspects.yaml`
- **ç»“æ„**ï¼šå®šä¹‰ L1/L2 å±‚çº§ã€è¯è¡¨ã€åˆ«åã€åœç”¨è¯ç­‰

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼ 1ï¼šWeb UI**

1. è¿›å…¥ "1ï¸âƒ£ è¦†ç›–ç‡å®éªŒå®¤" é¡µé¢
2. **è§„åˆ™åŒ¹é… (Tagging)**ï¼š
   - ç¡®è®¤é…ç½®æ–‡ä»¶å­˜åœ¨
   - ç‚¹å‡» "â–¶ï¸ è¿è¡Œè§„åˆ™åŒ¹é…"
   - ç­‰å¾…åŒ¹é…å®Œæˆ
3. **æ•ˆæœåˆ†æ (Analysis)**ï¼š
   - ç‚¹å‡» "ğŸ“Š å¼€å§‹åˆ†æè¦†ç›–ç‡"
   - æŸ¥çœ‹è¦†ç›–ç‡æŒ‡æ ‡å’Œæœªè¦†ç›–æ ·æœ¬
4. **AI è§„åˆ™è¿›åŒ–**ï¼ˆå¯é€‰ï¼‰ï¼š
   - ç‚¹å‡» "ğŸ¤– 1. AI æ™ºèƒ½åˆ†æ" è·å–è¯è¡¨ä¼˜åŒ–å»ºè®®
   - é¢„è§ˆå˜æ›´åç‚¹å‡» "âœ… 2. ç¡®è®¤å¹¶åº”ç”¨"
   - æˆ–æ‰‹åŠ¨ç¼–è¾‘ YAML é…ç½®

**æ–¹å¼ 2ï¼šå‘½ä»¤è¡Œ**

```bash
python -u scripts/tag_aspects.py \
  --input outputs/phone/clean_sentences.parquet \
  --config configs/domains/phone/aspects.yaml \
  --output-dir outputs/phone
```

#### è¾“å‡ºè¯´æ˜

- **aspect_sentences.parquet**ï¼šæ ‡æ³¨äº†æ–¹é¢è¯çš„å¥å­æ•°æ®
- **aspect_coverage_<domain>.xlsx**ï¼šè¦†ç›–ç‡æŠ¥è¡¨
- **aspect_counts_<domain>.xlsx**ï¼šå“ç‰Œ/å‹å·ç»´åº¦ç»Ÿè®¡

---

### Step 02: ç”Ÿæˆä¼ªæ ‡ç­¾

**ç›®æ ‡**ï¼šä½¿ç”¨ LLM API ä¸ºè®­ç»ƒå€™é€‰å¯¹ç”Ÿæˆä¼ªæ ‡ç­¾ï¼ˆTeacher æ¨¡å‹ï¼‰ã€‚

#### å‰ç½®æ¡ä»¶

- Step 01 å·²å®Œæˆï¼Œå­˜åœ¨ `aspect_sentences.parquet`
- å·²é…ç½® LLM APIï¼ˆåœ¨ Web UI ä¾§è¾¹æ æˆ–ç¯å¢ƒå˜é‡ä¸­ï¼‰

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼ 1ï¼šWeb UI**

1. è¿›å…¥ "2ï¸âƒ£ è®­ç»ƒä¸æ¨ç†" â†’ "ğŸ§  Step 02: ä¼ªæ ‡ç­¾ (API)" æ ‡ç­¾é¡µ
2. è®¾ç½®å‚æ•°ï¼š
   - **é‡‡æ ·æ•°é‡ (Sample Size)**ï¼šå‘é€ç»™ API çš„æ•°æ®é‡ï¼ˆæµ‹è¯•å»ºè®® 100-500ï¼Œç”Ÿäº§å»ºè®® 2000+ï¼‰
   - **API æ‰¹æ¬¡ (Batch Size)**ï¼šæ¯æ‰¹è¯·æ±‚çš„æ¡æ•°ï¼ˆé»˜è®¤ 10ï¼‰
3. ç‚¹å‡» "ğŸš€ è¿è¡Œ Step 02 (ç”Ÿæˆæ•°æ®)"
4. ç­‰å¾…å®Œæˆï¼ˆæ­¤æ­¥éª¤ä¸æ¶ˆè€—æ˜¾å¡ï¼Œä¸ä¼šå¯¼è‡´è¿‡çƒ­ï¼‰

**æ–¹å¼ 2ï¼šå‘½ä»¤è¡Œ**

```bash
python -u scripts/route_b_sentiment/pipeline.py \
  --domain phone \
  --run-id 20260105_phone_v0 \
  --input-aspect-sentences outputs/phone/aspect_sentences.parquet \
  --steps "02" \
  --step02-max-rows 500
```

#### è¾“å‡ºè¯´æ˜

- **step02_pseudo/train_pseudolabel.parquet**ï¼šå¸¦ä¼ªæ ‡ç­¾çš„è®­ç»ƒæ•°æ®

---

### Step 03: æ¨¡å‹è®­ç»ƒ

**ç›®æ ‡**ï¼šä½¿ç”¨ä¼ªæ ‡ç­¾è®­ç»ƒè½»é‡çº§ LoRA æ¨¡å‹ï¼ˆStudent æ¨¡å‹ï¼‰ã€‚

#### å‰ç½®æ¡ä»¶

- Step 02 å·²å®Œæˆ
- å…·å¤‡ GPUï¼ˆæ¨èï¼‰æˆ– CPUï¼ˆè¾ƒæ…¢ï¼‰

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼ 1ï¼šWeb UI**

1. è¿›å…¥ "2ï¸âƒ£ è®­ç»ƒä¸æ¨ç†" â†’ "ğŸ”¥ Step 03: è®­ç»ƒ (GPU)" æ ‡ç­¾é¡µ
2. **å‚æ•°è®¾ç½®**ï¼š
   - **åŸºåº§æ¨¡å‹**ï¼šé€‰æ‹©é¢„è®­ç»ƒæ¨¡å‹ï¼ˆæ¨è `hfl/chinese-macbert-base`ï¼‰
   - **Batch Size**ï¼šæ‰¹æ¬¡å¤§å°ï¼ˆ1-16ï¼Œæ ¹æ®æ˜¾å­˜è°ƒæ•´ï¼‰
   - **Grad Accum**ï¼šæ¢¯åº¦ç´¯ç§¯æ­¥æ•°ï¼ˆ1-16ï¼‰
   - **Epochs**ï¼šè®­ç»ƒè½®æ•°ï¼ˆé»˜è®¤ 3ï¼‰
3. **æ‰§è¡Œæ“ä½œ**ï¼š
   - å¦‚æœæ£€æµ‹åˆ°æ—§å­˜æ¡£ï¼Œå¯é€‰æ‹© "â–¶ï¸ ç»§ç»­è®­ç»ƒ (Resume)" æˆ– "ğŸ—‘ï¸ æ”¾å¼ƒæ—§è¿›åº¦ï¼Œé‡æ–°å¼€å§‹"
   - å¦åˆ™ç‚¹å‡» "ğŸ”¥ å¼€å§‹æ–°è®­ç»ƒ (Start)"

**æ–¹å¼ 2ï¼šå‘½ä»¤è¡Œ**

```bash
python -u scripts/route_b_sentiment/pipeline.py \
  --domain phone \
  --run-id 20260105_phone_v0 \
  --input-aspect-sentences outputs/phone/aspect_sentences.parquet \
  --steps "03" \
  --base-model hfl/chinese-macbert-base \
  --num-train-epochs 3 \
  --batch-size 4 \
  --grad-accum 4
```

#### è¾“å‡ºè¯´æ˜

- **step03_model/**ï¼šè®­ç»ƒå¥½çš„ LoRA æ¨¡å‹
  - `config.json`ï¼šæ¨¡å‹é…ç½®
  - `ckpt/`ï¼šæ£€æŸ¥ç‚¹ç›®å½•ï¼ˆæ”¯æŒæ–­ç‚¹ç»­è®­ï¼‰

#### æ³¨æ„äº‹é¡¹

- âš ï¸ **é«˜è´Ÿè½½é¢„è­¦**ï¼šæ­¤æ­¥éª¤ä¼šæ»¡è½½æ˜¾å¡ï¼Œå¯èƒ½å¯¼è‡´è¿‡çƒ­
- ç¬”è®°æœ¬ç”¨æˆ·å»ºè®®é™ä½ Batch Size å’Œ Grad Accum
- æ”¯æŒæ–­ç‚¹ç»­è®­ï¼Œè®­ç»ƒä¸­æ–­åå¯æ¢å¤

---

### Step 04: æ¨ç†ä¸éªŒè¯

**ç›®æ ‡**ï¼šä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹å¯¹å…¨é‡æ•°æ®è¿›è¡Œæƒ…æ„Ÿé¢„æµ‹ã€‚

#### å‰ç½®æ¡ä»¶

- Step 03 å·²å®Œæˆï¼Œå­˜åœ¨è®­ç»ƒå¥½çš„æ¨¡å‹

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼ 1ï¼šWeb UI**

1. è¿›å…¥ "2ï¸âƒ£ è®­ç»ƒä¸æ¨ç†" â†’ "ğŸ” Step 04: éªŒè¯ (æ¨ç†)" æ ‡ç­¾é¡µ
2. **æ¨¡å‹è·¯å¾„**ï¼šè‡ªåŠ¨å¡«å……æˆ–æ‰‹åŠ¨è¾“å…¥æ¨¡å‹è·¯å¾„
3. **æ€§èƒ½ä¸æ•£çƒ­è®¾ç½®**ï¼š
   - **æ¨ç† Batch Size**ï¼š4-128ï¼ˆç¬”è®°æœ¬å»ºè®® 8-16ï¼‰
   - **å¼€å¯"æ•£çƒ­å–˜æ¯"æ¨¡å¼**ï¼šæ¯æ‰¹æ¬¡è®¡ç®—åæš‚åœ 0.5 ç§’ï¼Œé˜²æ­¢æ˜¾å¡è¿‡çƒ­
4. é€‰æ‹©æ‰§è¡Œæ–¹å¼ï¼š
   - **âš¡ é‡æ–°æ¨ç† (æ¸…é™¤æ—§æ•°æ®)**ï¼šä»å¤´å¼€å§‹æ¨ç†
   - **â–¶ï¸ ç»§ç»­æ¨ç† (æ–­ç‚¹ç»­ä¼ )**ï¼šä»ä¸Šæ¬¡ä¸­æ–­å¤„ç»§ç»­

**æ–¹å¼ 2ï¼šå‘½ä»¤è¡Œ**

```bash
python -u scripts/route_b_sentiment/pipeline.py \
  --domain phone \
  --run-id 20260105_phone_v0 \
  --input-aspect-sentences outputs/phone/aspect_sentences.parquet \
  --steps "04" \
  --reuse-model outputs/phone/runs/20260105_phone_v0/step03_model \
  --step04-batch-size 8 \
  --step04-cool-down-time 0.5
```

#### è¾“å‡ºè¯´æ˜

- **step04_pred/asc_pred_ds/**ï¼šåˆ†ç‰‡é¢„æµ‹ç»“æœï¼ˆParquet æ ¼å¼ï¼‰
  - åŒ…å« `pred_id` (0/1/2)ã€`pred_label` (NEG/NEU/POS)ã€æ¦‚ç‡å€¼ç­‰

---

### Step 05: èšåˆä¸æŠ¥è¡¨

**ç›®æ ‡**ï¼šèšåˆé¢„æµ‹ç»“æœï¼Œç”Ÿæˆ Excel æŠ¥è¡¨å’Œ Web å¯¼å‡ºæ•°æ®ã€‚

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼ 1ï¼šWeb UI**

åœ¨ Step 04 æ ‡ç­¾é¡µä¸­ï¼Œ`--steps` å‚æ•°å·²åŒ…å« `05,web`ï¼Œæ¨ç†å®Œæˆåä¼šè‡ªåŠ¨æ‰§è¡Œèšåˆå’Œå¯¼å‡ºã€‚

**æ–¹å¼ 2ï¼šå‘½ä»¤è¡Œ**

```bash
python -u scripts/route_b_sentiment/pipeline.py \
  --domain phone \
  --run-id 20260105_phone_v0 \
  --input-aspect-sentences outputs/phone/aspect_sentences.parquet \
  --steps "05,web"
```

#### è¾“å‡ºè¯´æ˜

- **step05_agg/aspect_sentiment_counts_<domain>.xlsx**ï¼šå¤š Sheet Excel æŠ¥è¡¨
  - `all_summary`ï¼šæ€»ä½“ç»Ÿè®¡
  - `by_brand`ï¼šæŒ‰å“ç‰Œç»Ÿè®¡
  - `by_model`ï¼šæŒ‰å‹å·ç»Ÿè®¡
- **web_exports/**ï¼šWeb å‹å¥½æ ¼å¼
  - `last7d_day/`ï¼šè¿‘ 7 å¤©æŒ‰æ—¥ç»Ÿè®¡
  - `last1m_week/`ï¼šè¿‘ 30 å¤©æŒ‰å‘¨ç»Ÿè®¡

---

## å‘½ä»¤è¡Œä½¿ç”¨

### ç«¯åˆ°ç«¯è¿è¡Œï¼ˆæ¨èï¼‰

ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰æ­¥éª¤ï¼š

```bash
python -u scripts/pipeline_e2e.py \
  --domain phone \
  --run-id 20260105_phone
```

é»˜è®¤æ‰§è¡Œæ­¥éª¤ï¼š`00,tag,01,02,03,04,05,web`

### åŸŸçº§å¿«æ·è„šæœ¬

æ¯ä¸ªé¢†åŸŸæä¾›äº† PowerShell å¿«æ·è„šæœ¬ï¼š

```powershell
# å…¨é‡è¿è¡Œ
.\scripts\domains\phone\run_full.ps1

# å°æ ·æœ¬æµ‹è¯•ï¼ˆä»… Step 01-02ï¼‰
.\scripts\domains\phone\run_smoke.ps1
```

### Route B æµæ°´çº¿ï¼ˆåˆ†æ­¥ï¼‰

```bash
python -u scripts/route_b_sentiment/pipeline.py \
  --domain phone \
  --run-id 20260105_phone_v0 \
  --input-aspect-sentences outputs/phone/aspect_sentences.parquet \
  --steps "01,02,03,04,05,web"
```

**å¸¸ç”¨å‚æ•°**ï¼š

- `--steps`ï¼šé€—å·åˆ†éš”çš„æ­¥éª¤ï¼ˆ01-05, webï¼‰
- `--step02-max-rows`ï¼šStep 02 æœ€å¤§è¡Œæ•°ï¼ˆå°æ ·æœ¬æµ‹è¯•ï¼‰
- `--base-model`ï¼šStep 03 åŸºåº§æ¨¡å‹
- `--batch-size`ï¼šStep 03/04 æ‰¹æ¬¡å¤§å°
- `--resume`ï¼šæ–­ç‚¹ç»­ä¼ ï¼ˆæ”¯æŒ Step 01/03/04ï¼‰

---

## å¸¸è§é—®é¢˜

### 1. GPU ä¸å¯ç”¨æˆ–è¿‡çƒ­

- **è‡ªåŠ¨é™çº§**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹ GPUï¼Œä¸å¯ç”¨æ—¶é™çº§åˆ° CPU
- **é™ä½æ‰¹æ¬¡å¤§å°**ï¼šåœ¨ Step 03/04 ä¸­é™ä½ Batch Size
- **å¯ç”¨æ•£çƒ­æ¨¡å¼**ï¼šStep 04 ä¸­å¼€å¯ "æ•£çƒ­å–˜æ¯" æ¨¡å¼
- **ä½¿ç”¨è½»é‡æ¨¡å‹**ï¼šStep 03 é€‰æ‹© `bert-base-chinese` è€Œé MacBERT

### 2. OpenAI API é™æµ

- åœ¨ Step 02 ä¸­ä½¿ç”¨ `--step02-max-rows` é™åˆ¶æ•°æ®é‡è¿›è¡Œæµ‹è¯•
- è°ƒæ•´ `--batch-size` å‚æ•°
- ä½¿ç”¨ DeepSeek ç­‰å›½å†… API æœåŠ¡å•†

### 3. æ•°æ®æ–‡ä»¶æ‰¾ä¸åˆ°

- ç¡®è®¤æ•°æ®è·¯å¾„ï¼š`data/<domain>/<brand>/<model>/*.json|jsonl`
- æ£€æŸ¥ Web UI ä¾§è¾¹æ çš„ "å·¥ä½œåŒºè®¾ç½®"
- ç¡®è®¤ç¯å¢ƒå˜é‡ `ABSA_WORKSPACE` è®¾ç½®æ­£ç¡®

### 4. è¦†ç›–ç‡è¿‡ä½

- æŸ¥çœ‹ `aspect_coverage_<domain>.xlsx` ä¸­çš„æœªè¦†ç›– top terms
- ä½¿ç”¨ Web UI çš„ "AI è§„åˆ™è¿›åŒ–" åŠŸèƒ½ä¼˜åŒ–è¯è¡¨
- æ‰‹åŠ¨ç¼–è¾‘ `configs/domains/<domain>/aspects.yaml`

### 5. æ–­ç‚¹ç»­ä¼ 

- Step 00/01/04 æ”¯æŒ `--resume` å‚æ•°
- Step 03 è‡ªåŠ¨æ£€æµ‹æ£€æŸ¥ç‚¹ï¼Œæ”¯æŒç»§ç»­è®­ç»ƒ
- é‡å¤è¿è¡Œ Step 02/05 ä¼šè¦†ç›–è¾“å‡ºï¼ˆå»ºè®®æ¢ run_idï¼‰

---

## æ›´å¤šæ–‡æ¡£

- [é¡¹ç›®æ€»è§ˆ](docs/PROJECT_OVERVIEW.md)
- [æµæ°´çº¿è¿è¡Œæ‰‹å†Œ](docs/PIPELINE_RUNBOOK.md)
- [æ•°æ®å¥‘çº¦è¯´æ˜](docs/IO_CONTRACTS.md)
- [ç›®å½•ç»“æ„è¯¦è§£](docs/STRUCTURE.md)

---


